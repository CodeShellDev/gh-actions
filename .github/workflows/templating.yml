name: Template

on:
  workflow_call:
    inputs:
      template:
        required: true
        type: string

      source:
        required: false
        type: string
        default: "."

      output:
        required: true
        type: string

      recursive:
        required: false
        type: boolean
        default: false

      flatten:
        required: false
        type: boolean
        default: false

      match:
        required: false
        type: string
        default: ".*"

      whitespace:
        required: false
        type: string
        default: "t,l"

      push:
        required: false
        type: boolean
        default: true

      output-branch:
        required: false
        type: string
        default: ""

      force-push:
        required: false
        type: boolean
        default: false

      artifact:
        required: false
        type: string
        default: ""

      allow-pr:
        required: false
        type: boolean
        default: true

      pr-template:
        required: false
        type: string
        default: |
          # Automated Update

          This PR updates `${{ inputs.output }}` in the `${{ inputs.output-branch }}` branch.
          
          ## Changes
          - Updated files in `${{ inputs.output }}`
          - Ensures the branch has the latest templated content
          
          ## Notes
          - This PR was automatically generated by a Github Actions workflow using [goplater](https://github.com/codeshelldev/goplater).
          - Merge this PR to apply the updates.

    secrets:
      GH_TOKEN:
        required: true

jobs:
  template:
    runs-on: ubuntu-latest
    name: Template

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download goplater
        run: |
          curl -L https://github.com/CodeShellDev/goplater/releases/latest/download/goplater-linux-amd64 -o goplater

      - name: Make executable
        run: |
          chmod +x goplater

      - name: Template ${{ inputs.template }}
        run: |
          ./goplater template \
            ${{ inputs.template }} \
            -o=${{ inputs.output }} \
            -s=${{ inputs.source }} \
            -r=${{ inputs.recursive }} \
            -f=${{ inputs.flatten }} \
            -w=${{ inputs.whitespace }} \
            -i
              
      - name: Commit & Push ${{ inputs.output }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          OUTPUT: ${{ inputs.output }}
          BRANCH: ${{ inputs.output-branch }}
        run: |
          echo "Preparing to commit '${OUTPUT}' to branch '${BRANCH:-current branch}'"

          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          rm -f goplater

          # Fetch all branches
          git fetch origin

          # Move all files to /tmp
          mkdir -p /tmp/artifacts
          mv * /tmp/artifacts

          # Determine target branch (default to current)
          if [ -n "$BRANCH" ]; then
            if git ls-remote --exit-code origin "$BRANCH" >/dev/null 2>&1; then
              echo "Branch '$BRANCH' exists. Switching..."
              git switch "$BRANCH"
            else
              echo "Branch '$BRANCH' does not exist. Creating..."
              git switch --orphan "$BRANCH"
            fi
          fi

          # Move back files
          mv /tmp/artifacts/* .

          git add "$OUTPUT"
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update ${OUTPUT}"

          echo "Attempting direct push..."
          if git push origin HEAD:${BRANCH:-$(git rev-parse --abbrev-ref HEAD)}; then
            echo "✅ Successfully pushed changes."
            echo "PUSH_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "⚠️ Direct push failed. Will open a PR instead."
            echo "PUSH_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: Create Pull Request (Fallback)
        if: ${{ env.PUSH_SUCCESS == 'false' && inputs.allow-pr == true }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          branch: auto/update-${{ inputs.output }}-${{ github.run_id }}
          base: ${{ inputs.output-branch }}
          title: "Automated update of ${{ inputs.output }}"
          body: ${{ inputs.pr-template }}
          commit-message: "Update ${{ inputs.output }}"
          delete-branch: true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        if: ${{ inputs.artifact != '' }}
        with:
          name: ${{ inputs.artifact }}
          path: ${{ inputs.output }}

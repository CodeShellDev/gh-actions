name: Update Documentation

on:
  workflow_call:
    inputs:
      template-path:
        required: true
        type: string

      output-path:
        required: true
        type: string

      template-branch:
        required: false
        type: string
        default: docs

      output-branch:
        required: false
        type: string
        default: docs-build

    secrets:
      GH_TOKEN:
        required: true

jobs:
  docs:
    uses: codeshelldev/gh-actions/.github/workflows/templating.yml@main
    name: Docs
    with:
      template: ${{ inputs.template-path }}
      output: /tmp/${{ inputs.output-path }}
      recursive: true
      source: ${{ inputs.template-path }}
      push: false
      artifact: docs-output
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

  sync:
    name: Sync to ${{ inputs.output-branch }} branch
    runs-on: ubuntu-latest
    needs: docs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.template-branch }}
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Download templated output
        uses: actions/download-artifact@v4
        with:
          name: docs-output
          path: /tmp/docs-output

      - name: Prepare & Commit changes
        env:
          BRANCH: ${{ inputs.output-branch }}
          OUTPUT_PATH: ${{ inputs.output-path }}
        run: |
          echo "Syncing '${OUTPUT_PATH}' to '${BRANCH}'"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Ensure we have all branches
          git fetch origin

          # Check if the output branch exists
          if git ls-remote --exit-code origin "$BRANCH" >/dev/null 2>&1; then
            echo "Branch $BRANCH exists. Switching..."
            git switch $BRANCH
            git pull origin $BRANCH
          else
            echo "Branch $BRANCH does not exist. Creating new orphan branch..."
            git switch --orphan $BRANCH
            git rm -rf . || true
          fi

          # Copy all files from the template branch (so repo stays consistent)
          echo "Syncing all files from template branch..."
          git checkout ${{ inputs.template-branch }} -- .

          # Overwrite docs folder with templated output
          echo "Replacing '${OUTPUT_PATH}/' with templated version..."
          rm -rf "${OUTPUT_PATH}"
          mkdir -p "${OUTPUT_PATH}"
          rsync -a /tmp/docs-output/ "${OUTPUT_PATH}/"

          # Stage and push changes
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update ${{ inputs.output-path }}"
            git push -f origin HEAD:$BRANCH
          fi
